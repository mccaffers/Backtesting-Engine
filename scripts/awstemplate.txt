#!/bin/bash
{
export symbols=${symbols}
export runID=${runID}
export stopDistanceInPips=${stopDistanceInPips}
export limitDistanceInPips=${limitDistanceInPips}
export symbolFolder=${symbolFolder}
export scalingFactor="${scalingFactor}"
export accountEquity=${accountEquity}
export maximumDrawndownPercentage=${maximumDrawndownPercentage}
export strategy=${strategy}
export reportingEnabled=true
export s3Bucket="${s3Bucket}"
export s3Path=${s3Path}
export yearsStart=${yearsStart}
export yearsEnd=${yearsEnd}
export elasticUser=${elasticUser}
export elasticPassword="${elasticPassword}"
export elasticEndpoint="${elasticEndpoint}"
export elasticCloudID="${elasticCloudID}"
export runIteration=${runIteration}
export tradingSize=${tradingSize}
export instanceCount=${instanceCount}
export kineticStopLoss=${kineticStopLoss}
export kineticLimit=${kineticLimit}

export consoleLog=false
export systemLog=false

export DOTNET_CLI_TELEMETRY_OPTOUT=1

# Pull the project files
sudo yum install -y libicu60 zstd
aws s3api get-object --bucket ${awsDeployBucket} --key run/${runID}.zip /home/ec2-user/files.zip &

# Setup dotnet
export HOME=/root/
wget -q https://dot.net/v1/dotnet-install.sh 
sh dotnet-install.sh -c Current 
ln -s /root/.dotnet/dotnet /usr/bin/dotnet

# Free up some space
sudo yum clean all -y
sudo find /var -name "*.log" \( \( -size +50M -mtime +7 \) -o -mtime +30 \) -exec truncate {} --size 0 \;
sudo rm -rf /var/cache/yum

# Extract project files
cd /home/ec2-user/
mkdir /home/ec2-user/project
unzip files.zip -d ./project
rm -rf ./files.zip

# Run project
dotnet build /home/ec2-user/project -v q
dotnet run --project /home/ec2-user/project/src
poweroff
}  &> /home/ec2-user/output.txt 